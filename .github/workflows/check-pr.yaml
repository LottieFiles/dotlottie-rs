name: Build Artifacts

on:
  push:

jobs:
  build:
    runs-on: macos-12
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commitSHA || github.ref }}

      - uses: Homebrew/actions/setup-homebrew@master
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "13.3.1"

      - name: "Log xcode version"
        run: xcodebuild -version

      - name: "Log available xcodes"
        run: ls -l /Applications

      - name: "Log xcode sdks"
        run: xcodebuild -showsdks

      - name: "Log MacOSX SDKs"
        run: ls -l /Applications/Xcode_13.3.1.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/

      # - name: "Link MacOSX.sdk to MacOSX12.sdk"
      #   run: ln -sfn /Library/Developer/CommandLineTools/SDKs/MacOSX12.sdk /Library/Developer/CommandLineTools/SDKs/MacOSX.sdk

      - uses: ningenMe/setup-rustup@v1.1.0

      - name: Install Make
        run: brew install make

      - name: Build Setup
        run: make mac-setup

      - name: Build Apple
        env:
          APPLE_XCODE_APP_NAME: Xcode_13.3.1.app
          APPLE_MACOSX_SDK: MacOSX12.3
          APPLE_IOS_VERSION_MIN: 11.0
        run: rm -f /usr/local/lib/libjpeg* ; make apple

      - name: Upload Apple Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: apple
          path: ./release/apple/*.tar.gz