<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM test</title>
  </head>
  <body>
    <div style="max-width: 500px">
      <canvas style="width: 100%"></canvas>
    </div>
    <script type="module">
      import createDotLottiePlayerModule from "./release/wasm/DotLottiePlayer.js";

      const Module = await createDotLottiePlayerModule({
        locateFile: (path, prefix) => {
          if (path.endsWith(".wasm")) {
            return `./release/wasm/${path}`;
          }
          return `${prefix}${path}`;
        },
      });

      function create_Segments(start_frame, end_frame) {
        const vector = new Module.VectorFloat();

        vector.push_back(start_frame);
        vector.push_back(end_frame);

        return vector;
      }

      const dotLottie = new Module.DotLottiePlayer({
        autoplay: true,
        loop_animation: true,
        mode: Module.Mode.values[3],
        speed: 1,
        use_frame_interpolation: true,
        segments: create_Segments(0, 22),
      });

      const data = await fetch(
        "https://lottie.host/647eb023-6040-4b60-a275-e2546994dd7f/zDCfp5lhLe.json"
      ).then((res) => res.text());
      const canvas = document.querySelector("canvas");

      const { width: client_width, height: client_height } =
        canvas.getBoundingClientRect();

      const width = client_width * (window.devicePixelRatio || 1);
      const height = client_height * (window.devicePixelRatio || 1);

      canvas.width = width;
      canvas.height = height;

      const loaded = dotLottie.load_animation_data(data, width, height);

      const ctx = canvas.getContext("2d");
      const imageData = ctx.createImageData(width, height);

      function animationLoop() {
        const next_frame_number = dotLottie.request_frame();
        console.log(next_frame_number);
        dotLottie.set_frame(next_frame_number);
        const rendered = dotLottie.render();

        if (rendered) {
          const frame_buffer = dotLottie.buffer();
          imageData.data.set(frame_buffer);
          ctx.putImageData(imageData, 0, 0);
        }

        requestAnimationFrame(animationLoop);
      }

      requestAnimationFrame(animationLoop);
    </script>
  </body>
</html>
