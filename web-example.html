<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM test</title>
  </head>

  <body>
    <h1>Test</h1>
    <canvas style="width: 100%; height: 100%"></canvas>
    <script type="module">
      import createDotLottiePlayerModule from "./release/wasm/DotLottiePlayer.mjs";

      const canvas = document.querySelector("canvas");

      canvas.setAttribute("data-id", "dotlottie-canvas");

      const adapter = await navigator.gpu.requestAdapter();
      const device = await adapter.requestDevice();

      const Module = await createDotLottiePlayerModule({
        locateFile: (path, prefix) => {
          if (path.endsWith(".wasm")) {
            return `release/wasm/${path}`;
          }
          return `${prefix}${path}`;
        },
        preinitializedWebGPUDevice: device,
      });

      // let renderer = Module.TvgEngine.TvgEngineSw;
      // let renderer = Module.TvgEngine.TvgEngineGl;
      let renderer = Module.TvgEngine.TvgEngineWg;

      let ctx;
      if (renderer == Module.TvgEngine.TvgEngineSw) {
        ctx = canvas.getContext("2d");
      }

      const { height, width } = canvas.getBoundingClientRect();

      canvas.width = width * window.devicePixelRatio;
      canvas.height = height * window.devicePixelRatio;

      console.log(canvas.width, canvas.height);

      console.log(Module);

      const player = new Module.DotLottiePlayer(
        {
          ...Module.createDefaultConfig(),
          autoplay: true,
          loopAnimation: true,
        },
        renderer,
        0,
        "[data-id='dotlottie-canvas']"
      );

      const data = await fetch(
        // "https://lottie.host/5c89381e-0d1a-4422-8247-f5b7e4b3c4e2/mqs5juC4PW.lottie"
        // "./examples/demo-player/src/cartoon.json"
        "https://lottie.host/294b684d-d6b4-4116-ab35-85ef566d4379/VkGHcqcMUI.lottie"
        // "https://lottie.host/edff17eb-9a84-41f7-810a-22b94fbf9143/uYveqJ1Kqn.lottie"
      ).then((res) => res.arrayBuffer());

      const loaded = player.loadDotLottieData(
        data,
        canvas.width,
        canvas.height
      );

      console.log({ loaded });

      const draw = () => {
        if (player.isPlaying()) {
          const nextFrame = player.requestFrame();
          if (player.setFrame(nextFrame)) {
            if (renderer == Module.TvgEngine.TvgEngineSw) {
              const frameBuffer = player.buffer();
              const imageData = ctx.createImageData(
                canvas.width,
                canvas.height
              );
              imageData.data.set(frameBuffer);
              ctx.putImageData(imageData, 0, 0);
            }
            player.render();
          }
        }

        requestAnimationFrame(draw);
      };

      draw();

      window.addEventListener("resize", () => {
        const { height, width } = canvas.getBoundingClientRect();
        canvas.width = width * window.devicePixelRatio;
        canvas.height = height * window.devicePixelRatio;
        player.resize(canvas.width, canvas.height);
      });

      setInterval(() => {
        const randomColor = Math.floor(Math.random() * 16777215);
        player.setConfig({
          ...player.config(),
          backgroundColor: randomColor,
        });
      }, 1000);
    </script>
  </body>
</html>
