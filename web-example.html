<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM test</title>
  </head>
  <body>
    <div style="max-width: 500px">
      <canvas style="width: 100%; border: 1px solid black"></canvas>
      <button id="play">play</button>
      <button id="pause">pause</button>
      <input
        id="progress-bar"
        type="range"
        min="0"
        max="100"
        defaultValue="0"
        step="0.01"
      />
    </div>
    <button id="jump">Jump</button>
    <script type="module">
      import createDotLottiePlayerModule from "./release/wasm/DotLottiePlayer.mjs";

      const playBtn = document.querySelector("#play");
      const pauseBtn = document.querySelector("#pause");
      const progressBar = document.querySelector("#progress-bar");
      const jumpBtn = document.querySelector("#jump");

      const Module = await createDotLottiePlayerModule({
        locateFile: (path, prefix) => {
          if (path.endsWith(".wasm")) {
            return `release/wasm/${path}`;
          }
          return `${prefix}${path}`;
        },
      });

      function createSegments(startFrame, endFrame) {
        const vector = new Module.VectorFloat();

        if (typeof startFrame === "number" && typeof endFrame === "number") {
          vector.push_back(startFrame);
          vector.push_back(endFrame);
        }

        return vector;
      }

      const dotLottiePlayer = new Module.DotLottiePlayer({
        autoplay: true,
        loopAnimation: true,
        mode: Module.Mode.values[3],
        speed: 1,
        useFrameInterpolation: true,
        segments: createSegments(0, 40),
        backgroundColor: 0x000000,
      });

      // const data = await fetch(
      //   "https://lottie.host/647eb023-6040-4b60-a275-e2546994dd7f/zDCfp5lhLe.json"
      // ).then((res) => res.text());

      const data = await fetch(
        "https://lottie.host/294b684d-d6b4-4116-ab35-85ef566d4379/VkGHcqcMUI.lottie"
        // "https://lottie.host/edff17eb-9a84-41f7-810a-22b94fbf9143/uYveqJ1Kqn.lottie"
      ).then((res) => res.arrayBuffer());

      const canvas = document.querySelector("canvas");

      const { width: clientWidth, height: clientHeight } =
        canvas.getBoundingClientRect();

      const width = clientWidth * (window.devicePixelRatio || 1);
      const height = clientHeight * (window.devicePixelRatio || 1);

      canvas.width = width;
      canvas.height = height;

      // const loaded = dotLottiePlayer.loadAnimationData(data, width, height);
      const loaded = dotLottiePlayer.loadDotLottieData(data, width, height);

      dotLottiePlayer.setConfig({
        ...dotLottiePlayer.config(),
        mode: Module.Mode.values[3],
        segments: createSegments(),
      });

      console.log("Loaded: ", loaded);

      // const manifest = JSON.parse(dotLottiePlayer.manifestString());
      // const animationId = manifest.animations[2].id;
      // dotLottiePlayer.loadAnimation(animationId, width, height);

      // dotLottiePlayer.setBackgroundColor(0x9afafa8f);

      const ctx = canvas.getContext("2d");
      const imageData = ctx.createImageData(width, height);

      let animationFrameId = null;

      function animationLoop() {
        const nextFrameNumber = dotLottiePlayer.requestFrame();
        // console.log(nextFrameNumber);

        const updated = dotLottiePlayer.setFrame(nextFrameNumber);

        if (updated) {
          progressBar.value =
            (dotLottiePlayer.currentFrame() / dotLottiePlayer.totalFrames()) *
            100;

          const rendered = dotLottiePlayer.render();

          if (rendered) {
            const frameBuffer = dotLottiePlayer.buffer();
            imageData.data.set(frameBuffer);
            ctx.putImageData(imageData, 0, 0);
          }
        }

        animationFrameId = requestAnimationFrame(animationLoop);
      }

      animationFrameId = requestAnimationFrame(animationLoop);

      playBtn.addEventListener("click", () => {
        dotLottiePlayer.play();
      });

      pauseBtn.addEventListener("click", () => {
        dotLottiePlayer.pause();
      });

      jumpBtn.addEventListener("click", () => {
        dotLottiePlayer.setFrame(44);
      });

      progressBar.addEventListener("mousedown", () => {
        cancelAnimationFrame(animationFrameId);
      });

      progressBar.addEventListener("mouseup", () => {
        animationFrameId = requestAnimationFrame(animationLoop);
      });

      progressBar.addEventListener("input", (event) => {
        const newFrame =
          (event.target.value / 100) * dotLottiePlayer.totalFrames();

        const updated = dotLottiePlayer.setFrame(newFrame);
        if (updated) {
          const rendered = dotLottiePlayer.render();
          if (rendered) {
            const frameBuffer = dotLottiePlayer.buffer();
            imageData.data.set(frameBuffer);
            ctx.putImageData(imageData, 0, 0);
          }
        }
      });
    </script>
  </body>
</html>
