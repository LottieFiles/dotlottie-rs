<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WASM test</title>
  </head>
  <body>
    <canvas width="500" height="500"></canvas>
    <script type="module">
      import createModule from "./release/wasm/DotLottiePlayer.js";

      const module = await createModule({
        locateFile: (path, prefix) => {
          if (path.endsWith(".wasm")) {
            return `./release/wasm/${path}`;
          }
          return `${prefix}${path}`;
        },
      });

      const player = new module.DotLottiePlayer({
        autoplay: true,
        loop_animation: true,
        mode: module.Mode.values[1],
        speed: 1,
        use_frame_interpolation: false,
      });

      const data = await fetch(
        "https://lottie.host/647eb023-6040-4b60-a275-e2546994dd7f/zDCfp5lhLe.json"
      ).then((res) => res.text());
      const canvas = document.querySelector("canvas");

      const width = canvas.width;
      const height = canvas.height;

      const loaded = player.load_animation_data(data, width, height);

      const ctx = canvas.getContext("2d");
      const imageData = ctx.createImageData(width, height);

      // const duration = player.duration(); // duration in seconds
      // const totalFrames = player.total_frames();
      // const fps = totalFrames / duration;
      // const timePerFrame = 1000 / fps; // time per frame in milliseconds

      // let lastFrameTime = 0;

      // let currentFrame = 0;

      // const animationLoop = (timestamp) => {
      //   if (!lastFrameTime || timestamp - lastFrameTime >= timePerFrame) {
      //     player.set_frame(currentFrame);

      //     const rendered = player.render();
      //     if (rendered) {
      //       const buffer = player.buffer();

      //       imageData.data.set(buffer);
      //       ctx.putImageData(imageData, 0, 0);
      //     }

      //     currentFrame++;

      //     if (currentFrame >= totalFrames) {
      //       currentFrame = 0;
      //     }

      //     lastFrameTime = timestamp;
      //   }

      //   requestAnimationFrame(animationLoop);
      // };

      // requestAnimationFrame(animationLoop);

      function animationLoop() {
        const frame = player.request_frame();

        player.set_frame(frame);
        player.render();

        const buffer = player.buffer();

        imageData.data.set(buffer);
        ctx.putImageData(imageData, 0, 0);

        requestAnimationFrame(animationLoop);
      }

      requestAnimationFrame(animationLoop);
    </script>
  </body>
</html>
